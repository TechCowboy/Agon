Zilog eZ80 Macro Assembler Version 4.3 (19073001)19-Jul-22     21:22:36     page:   1


PC     Object              I  Line    Source 
                           A     1    ;
                           A     2    ; Title:	AGON MOS - C Startup Code
                           A     3    ; Author:	Copyright (C) 2005 by ZiLOG, Inc.  
                           A     4    ; Modified By:	Dean Belfield
                           A     5    ; Created:	10/07/2022
                           A     6    ; Last Updated:	15/07/2022
                           A     7    ;
                           A     8    ; Modinfo:
                           A     9    ; 14/07/2022:	Added coldBoot detection, exec1
                           A    10    ; 15/07/2022:	Added further hardware/firmware
                           A    11    
                           B     0    			INCLUDE	"../src/macros.inc"
                           B     1    ;
                           B     2    ; Title:	AGON MOS - Useful Macros
                           B     3    ; Author:	Dean Belfield
                           B     4    ; Created:	15/07/2022
                           B     5    ; Last Updated:	15/07/2022
                           B     6    ;
                           B     7    ; Modinfo:
                           B     8    
                           B     9    ADD8U_HL:		MACRO 
                           B    10    			ADD	A, L 
                           B    11    			LD	L, A 
                           B    12    			ADC	A, H
                           B    13    			SUB	L
                           B    14    			LD	H, A 
                           B    15    			ENDMACRO 
                           B    16    
                           B    17    SET_GPIO:		MACRO	REG, VAL
                           B    18    			IN0	A,(REG)
                           B    19    			OR	VAL
                           B    20    			OUT0	(REG),A
                           B    21    			ENDMACRO
                           B    22    				
                           B    23    RES_GPIO:		MACRO	REG, VAL
                           B    24    			PUSH	BC
                           B    25    			LD	A, VAL
                           B    26    			CPL
                           B    27    			LD	C, A
                           B    28    			IN0	A,(REG)
                           B    29    			AND	C
                           B    30    			OUT0	(REG),A
                           B    31    			POP	BC
                           B    32    			ENDMACRO
                           B    33    			
                           B     0    			INCLUDE	"../src/equs.inc"
                           B     1    ;
                           B     2    ; Title:	AGON MOS - Equs
                           B     3    ; Author:	Dean Belfield
                           B     4    ; Created:	15/07/2022
                           B     5    ; Last Updated:	15/07/2022
                           B     6    ;
                           B     7    ; Modinfo:
                           B     8    
                           B     9    ; For GPIO
                           B    10    ; PA not available on eZ80F92
                           B    11    ;
       00000096            B    12    PA_DR:			EQU		96h
       00000097            B    13    PA_DDR:			EQU		97h
       00000098            B    14    PA_ALT1:		EQU		98h
       00000099            B    15    PA_ALT2:		EQU		99h
       0000009A            B    16    PB_DR:          	EQU		9Ah
       0000009B            B    17    PB_DDR:        	 	EQU		9Bh
       0000009C            B    18    PB_ALT1:        	EQU		9Ch
       0000009D            B    19    PB_ALT2:        	EQU		9Dh
       0000009E            B    20    PC_DR:          	EQU		9Eh
       0000009F            B    21    PC_DDR:         	EQU		9Fh
       000000A0            B    22    PC_ALT1:        	EQU		A0h
       000000A1            B    23    PC_ALT2:        	EQU		A1h
       000000A2            B    24    PD_DR:          	EQU		A2h
       000000A3            B    25    PD_DDR:			EQU		A3h
       000000A4            B    26    PD_ALT1:		EQU		A4h
       000000A5            B    27    PD_ALT2:		EQU		A5h
                           B    28    	
       00000000            B    29    GPIOMODE_OUT:		EQU		0	; Output
       00000001            B    30    GPIOMODE_IN:		EQU		1	; Input
       00000002            B    31    GPIOMODE_DIO:		EQU		2	; Open Drain IO
       00000003            B    32    GPIOMODE_SIO:		EQU		3	; Open Source I
       00000004            B    33    GPIOMODE_INTD:		EQU		4	; Interrupt, Du
       00000005            B    34    GPIOMODE_ALTF:		EQU		5;	; Alt Function
       00000006            B    35    GPIOMODE_INTAL:		EQU		6	; Interrupt, Ac
       00000007            B    36    GPIOMODE_INTAH:		EQU		7	; Interrupt, Ac
       00000008            B    37    GPIOMODE_INTFE:		EQU		8	; Interrupt, Fa
       00000009            B    38    GPIOMODE_INTRE:		EQU		9	; Interrupt, Ri
                           B    39    	
                           B    40    ; For interrupts.asm
                           B    41    ;
                           B    42    
                           B    43    ;UARTs
                           B    44    ;
       00000018            B    45    UART0_IVECT		EQU	18h
       0000001A            B    46    UART1_IVECT		EQU	1Ah
                           B    47    
                           B    48    ;Ports
                           B    49    ;
       00000030            B    50    PB0_IVECT   		EQU   	30h	; AGON ITRP Int
       00000032            B    51    PB1_IVECT  	  	EQU  	32h	; AGON VBLANK Inter
       00000034            B    52    PB2_IVECT  	  	EQU   	34h
       00000036            B    53    PB3_IVECT  	  	EQU   	36h
       00000038            B    54    PB4_IVECT    		EQU   	38h
       0000003A            B    55    PB5_IVECT    		EQU   	3Ah
       0000003C            B    56    PB6_IVECT    		EQU   	3Ch
       0000003E            B    57    PB7_IVECT    		EQU   	3Eh
                           B    58                           
       00000040            B    59    PC0_IVECT    		EQU   	40h
       00000042            B    60    PC1_IVECT    		EQU   	42h
       00000044            B    61    PC2_IVECT    		EQU   	44h
       00000046            B    62    PC3_IVECT    		EQU   	46h
       00000048            B    63    PC4_IVECT    		EQU   	48h
       0000004A            B    64    PC5_IVECT    		EQU   	4Ah
       0000004C            B    65    PC6_IVECT    		EQU   	4Ch
       0000004E            B    66    PC7_IVECT    		EQU   	4Eh
                           B    67                           
       00000050            B    68    PD0_IVECT    		EQU   	50h
       00000052            B    69    PD1_IVECT    		EQU   	52h
       00000054            B    70    PD2_IVECT    		EQU   	54h
       00000056            B    71    PD3_IVECT    		EQU   	56h
       00000058            B    72    PD4_IVECT    		EQU   	58h
       0000005A            B    73    PD5_IVECT    		EQU   	5Ah
       0000005C            B    74    PD6_IVECT    		EQU   	5Ch
       0000005E            B    75    PD7_IVECT    		EQU   	5Eh
                           A    14    
                           B     0    			INCLUDE "ez80f92.inc"
                           B     1    ;**********************************************
                           B     2    ;*    eZ80F92.inc
                           B     3    ;*
                           B     4    ;*		eZ80F92 Registers
                           B     5    ;*
                           B     6    ;**********************************************
                           B     7    ;* Start eZ80F92 Include file
                           B     8    
                           B     9    ;* TIMER registers
                           B    10    
       00000080            B    11    TMR0_CTL:	.equ  %80
       00000081            B    12    TMR0_DR_L:	.equ  %81
       00000081            B    13    TMR0_RR_L:	.equ  %81
       00000082            B    14    TMR0_DR_H:	.equ  %82
       00000082            B    15    TMR0_RR_H:	.equ  %82
       00000083            B    16    TMR1_CTL:	.equ  %83
       00000084            B    17    TMR1_DR_L:	.equ  %84
       00000084            B    18    TMR1_RR_L:	.equ  %84
       00000085            B    19    TMR1_DR_H:	.equ  %85
       00000085            B    20    TMR1_RR_H:	.equ  %85
       00000086            B    21    TMR2_CTL:	.equ  %86
       00000087            B    22    TMR2_DR_L:	.equ  %87
       00000087            B    23    TMR2_RR_L:	.equ  %87
       00000088            B    24    TMR2_DR_H:	.equ  %88
       00000088            B    25    TMR2_RR_H:	.equ  %88
       00000089            B    26    TMR3_CTL:	.equ  %89
       0000008A            B    27    TMR3_DR_L:	.equ  %8a
       0000008A            B    28    TMR3_RR_L:	.equ  %8a
       0000008B            B    29    TMR3_DR_H:	.equ  %8b
       0000008B            B    30    TMR3_RR_H:	.equ  %8b
       0000008C            B    31    TMR4_CTL:	.equ  %8c
       0000008D            B    32    TMR4_DR_L:	.equ  %8d
       0000008D            B    33    TMR4_RR_L:	.equ  %8d
       0000008E            B    34    TMR4_DR_H:	.equ  %8e
       0000008E            B    35    TMR4_RR_H:	.equ  %8e
       0000008F            B    36    TMR5_CTL:	.equ  %8f
       00000090            B    37    TMR5_DR_L:	.equ  %90
       00000090            B    38    TMR5_RR_L:	.equ  %90
       00000091            B    39    TMR5_DR_H:	.equ  %91
       00000091            B    40    TMR5_RR_H:	.equ  %91
       00000092            B    41    TMR_ISS:	.equ  %92
                           B    42    
                           B    43    ;* WDT Registers
                           B    44    
       00000093            B    45    WDT_CTL:	.equ %93
       00000094            B    46    WDT_RR:	.equ  %94
                           B    47    
                           B    48    
                           B    49    ;* PORT Registers
                           B    50    
                           B    51    PB_DR:		.equ %9A
                           B    52    PB_DDR:		.equ %9B
                           B    53    PB_ALT1:	.equ %9C
                           B    54    PB_ALT2:	.equ %9D
                           B    55    PC_DR:		.equ %9E
                           B    56    PC_DDR:		.equ %9F
                           B    57    PC_ALT1:	.equ %A0
                           B    58    PC_ALT2:	.equ %A1
                           B    59    PD_DR:		.equ %A2
                           B    60    PD_DDR:		.equ %A3
                           B    61    PD_ALT1:	.equ %A4
                           B    62    PD_ALT2:	.equ %A5
                           B    63    
                           B    64    ;* Chip Select
       000000A8            B    65    CS0_LBR:	.equ %A8
       000000A9            B    66    CS0_UBR:	.equ %A9
       000000AA            B    67    CS0_CTL:	.equ %AA
       000000AB            B    68    CS1_LBR:	.equ %AB
       000000AC            B    69    CS1_UBR:	.equ %AC
       000000AD            B    70    CS1_CTL:	.equ %AD
       000000AE            B    71    CS2_LBR:	.equ %AE
       000000AF            B    72    CS2_UBR:	.equ %AF
       000000B0            B    73    CS2_CTL:	.equ %B0
       000000B1            B    74    CS3_LBR:	.equ %B1
       000000B2            B    75    CS3_UBR:	.equ %B2
       000000B3            B    76    CS3_CTL:	.equ %B3
                           B    77    
                           B    78    ;* RAMCTL Registers
       000000B4            B    79    RAM_CTL0:	.equ %B4
       000000B4            B    80    RAM_CTL:	.equ %B4
       000000B5            B    81    RAM_ADDR_U:	.equ %B5
                           B    82    
                           B    83    ;* SPI Registers
                           B    84    
       000000B8            B    85    SPI_BRG_L:	.equ %B8
       000000B9            B    86    SPI_BRG_H:	.equ %B9
       000000BA            B    87    SPI_CTL:	.equ %BA
       000000BB            B    88    SPI_SR:		.equ %BB
       000000BC            B    89    SPI_RBR:	.equ %BC
       000000BC            B    90    SPI_TSR:	.equ %BC
                           B    91    
                           B    92    ;* UART0 Registers
                           B    93    
       000000C0            B    94    UART0_RBR:	.equ  %C0
       000000C0            B    95    UART0_THR:	.equ  %C0
       000000C0            B    96    UART0_BRG_L:	.equ  %C0
       000000C1            B    97    UART0_IER:	.equ  %C1
       000000C1            B    98    UART0_BRG_H:	.equ  %C1
       000000C2            B    99    UART0_IIR:	.equ  %C2
       000000C2            B   100    UART0_FCTL:	.equ  %C2
       000000C3            B   101    UART0_LCTL:	.equ  %C3
       000000C4            B   102    UART0_MCTL:	.equ  %C4
       000000C5            B   103    UART0_LSR:	.equ  %C5
       000000C6            B   104    UART0_MSR:	.equ  %C6
       000000C7            B   105    UART0_SPR:	.equ  %C7
                           B   106    
                           B   107    ;* I2C Registers
                           B   108    
       000000C8            B   109    I2C_SAR:	.equ  %C8
       000000C9            B   110    I2C_XSAR:	.equ  %C9
       000000CA            B   111    I2C_DR:		.equ  %CA
       000000CB            B   112    I2C_CTL:	.equ  %CB
       000000CC            B   113    I2C_SR:		.equ  %CC
       000000CC            B   114    I2C_CCR:	.equ  %CC
       000000CD            B   115    I2C_SRR:	.equ  %CD
                           B   116    
                           B   117    ;* UART1 Registers
                           B   118    
       000000D0            B   119    UART1_RBR:	.equ  %D0
       000000D0            B   120    UART1_THR:	.equ  %D0
       000000D0            B   121    UART1_BRG_L:	.equ  %D0
       000000D1            B   122    UART1_IER:	.equ  %D1
       000000D1            B   123    UART1_BRG_H:	.equ  %D1
       000000D2            B   124    UART1_IIR:	.equ  %D2
       000000D2            B   125    UART1_FCTL:	.equ  %D2
       000000D3            B   126    UART1_LCTL:	.equ  %D3
       000000D4            B   127    UART1_MCTL:	.equ  %D4
       000000D5            B   128    UART1_LSR:	.equ  %D5
       000000D6            B   129    UART1_MSR:	.equ  %D6
       000000D7            B   130    UART1_SPR:	.equ  %D7
                           B   131    
                           B   132    ;* IR Registers
                           B   133    
       000000BF            B   134    IR_CTL:		.equ   %BF
                           B   135    
                           B   136    ;* CLK Registers
                           B   137    
       000000DB            B   138    CLK_PPD1:	.equ   %DB
       000000DC            B   139    CLK_PPD2:	.equ   %DC
                           B   140    
                           B   141    ;* RTC Registers
                           B   142    
       000000E0            B   143    RTC_SEC:	.equ  %E0
       000000E1            B   144    RTC_MIN:	.equ  %E1
       000000E2            B   145    RTC_HRS:	.equ  %E2
       000000E3            B   146    RTC_DOW:	.equ  %E3
       000000E4            B   147    RTC_DOM:	.equ  %E4
       000000E5            B   148    RTC_MON:	.equ  %E5
       000000E6            B   149    RTC_YR:		.equ  %E6
       000000E7            B   150    RTC_CEN:	.equ  %E7
       000000E8            B   151    RTC_ASEC:	.equ  %E8
       000000E9            B   152    RTC_AMIN:	.equ  %E9
       000000EA            B   153    RTC_AHRS:	.equ  %EA
       000000EB            B   154    RTC_ADOW:	.equ  %EB
       000000EC            B   155    RTC_ACTRL:	.equ  %EC
       000000ED            B   156    RTC_CTRL:	.equ  %ED
                           B   157    
                           B   158    ;* CSBMC Registers
                           B   159    
       000000F0            B   160    CS0_BMC:	.equ %F0
       000000F1            B   161    CS1_BMC:	.equ %F1
       000000F2            B   162    CS2_BMC:	.equ %F2
       000000F3            B   163    CS3_BMC:	.equ %F3
                           B   164    
                           B   165    ;* FLASH Registers
                           B   166    
       000000F5            B   167    FLASH_KEY:	.equ  %F5
       000000F6            B   168    FLASH_DATA:	.equ  %F6
       000000F7            B   169    FLASH_ADDR_U:	.equ  %F7
       000000F8            B   170    FLASH_CTRL:	.equ  %F8
       000000F9            B   171    FLASH_FDIV:	.equ  %F9
       000000FA            B   172    FLASH_PROT:	.equ  %FA
       000000FB            B   173    FLASH_IRQ:	.equ  %FB
       000000FC            B   174    FLASH_PAGE:	.equ  %FC
       000000FD            B   175    FLASH_ROW:	.equ  %FD
       000000FE            B   176    FLASH_COL:	.equ  %FE
       000000FF            B   177    FLASH_PGCTL:	.equ  %FF
                           B   178    
                           B   179    ;* End eZ80F92 inc file 
                           A    16    
                           A    17    			XREF	__stack
                           A    18    			XREF	__init_default_vectors
                           A    19    			XREF	__c_startup
                           A    20    			XREF	__cstartup
                           A    21    			XREF	_main
                           A    22    			XREF	__CS0_LBR_INIT_PARAM
                           A    23    			XREF	__CS0_UBR_INIT_PARAM
                           A    24    			XREF	__CS0_CTL_INIT_PARAM
                           A    25    			XREF	__CS1_LBR_INIT_PARAM
                           A    26    			XREF	__CS1_UBR_INIT_PARAM
                           A    27    			XREF	__CS1_CTL_INIT_PARAM
                           A    28    			XREF	__CS2_LBR_INIT_PARAM
                           A    29    			XREF	__CS2_UBR_INIT_PARAM
                           A    30    			XREF	__CS2_CTL_INIT_PARAM
                           A    31    			XREF	__CS3_LBR_INIT_PARAM
                           A    32    			XREF	__CS3_UBR_INIT_PARAM
                           A    33    			XREF	__CS3_CTL_INIT_PARAM
                           A    34    			XREF	__CS0_BMC_INIT_PARAM
                           A    35    			XREF	__CS1_BMC_INIT_PARAM
                           A    36    			XREF	__CS2_BMC_INIT_PARAM
                           A    37    			XREF	__CS3_BMC_INIT_PARAM
                           A    38    			XREF	__FLASH_CTL_INIT_PARAM
                           A    39    			XREF	__FLASH_ADDR_U_INIT_PARAM
                           A    40    			XREF	__RAM_CTL_INIT_PARAM
                           A    41    			XREF	__RAM_ADDR_U_INIT_PARAM
                           A    42    
                           A    43    			XDEF	__init
                           A    44    			XDEF	_abort
                           A    45    			XDEF	__exit
                           A    46    			XDEF	_exit
                           A    47    			
                           A    48    			XDEF	__exec16
                           A    49    			XDEF	_exec16
                           A    50    			
                           A    51    			XREF	GPIOB_SETMODE
                           A    52    
                           A    53    ; Startup code
                           A    54    ;
                           A    55    			DEFINE .STARTUP, SPACE = ROM
                           A    56    			SEGMENT .STARTUP
                           A    57    			
                           A    58    			.ASSUME ADL = 1
                           A    59    
                           A    60    ; Minimum default initialization
                           A    61    ;
                           A    62    ; Disable internal peripheral interrupt sources
                           A    63    ; -- this will help during a RAM debug session 
                           A    64    ;
000000 3EFF                A    65    __init:			ld a, %FF
000002 ED399B              A    66    			out0 (PB_DDR), a         ; GPIO
000005 ED399F              A    67    			out0 (PC_DDR), a         ;
000008 ED39A3              A    68    			out0 (PD_DDR), a         ;
00000B 3E00                A    69    			ld a, %00
00000D ED399C              A    70    			out0 (PB_ALT1), a        ;
000010 ED39A0              A    71    			out0 (PC_ALT1), a        ;
000013 ED39A4              A    72    			out0 (PD_ALT1), a        ;
000016 ED399D              A    73    			out0 (PB_ALT2), a        ;
000019 ED39A1              A    74    			out0 (PC_ALT2), a        ;
00001C ED39A5              A    75    			out0 (PD_ALT2), a        ;
00001F ED3980              A    76    			out0 (TMR0_CTL), a       ; timers
000022 ED3983              A    77    			out0 (TMR1_CTL), a       ;
000025 ED3986              A    78    			out0 (TMR2_CTL), a       ;
000028 ED3989              A    79    			out0 (TMR3_CTL), a       ;
00002B ED398C              A    80    			out0 (TMR4_CTL), a       ;
00002E ED398F              A    81    			out0 (TMR5_CTL), a       ;
000031 ED39C1              A    82    			out0 (UART0_IER), a      ; UARTs
000034 ED39D1              A    83    			out0 (UART1_IER), a      ;
000037 ED39CB              A    84    			out0 (I2C_CTL), a        ; I2C
00003A ED39FB              A    85    			out0 (FLASH_IRQ), a      ; Flash
00003D 3E04                A    86    			ld a, %04
00003F ED39BA              A    87    			out0 (SPI_CTL), a        ; SPI
000042 ED38ED              A    88    			in0 a, (RTC_CTRL)        ; RTC, Wri
000045 E6BE                A    89    			and a, %BE               ;      res
000047 ED39ED              A    90    			out0 (RTC_CTRL), a       ;      the
                           A    91    ;
                           A    92    ; Configure external memory/io
                           A    93    ;
00004A 3E 00               A    94    			ld a, __CS0_LBR_INIT_PARAM
00004C ED39A8              A    95    			out0 (CS0_LBR), a
00004F 3E 00               A    96    			ld a, __CS0_UBR_INIT_PARAM
000051 ED39A9              A    97    			out0 (CS0_UBR), a
000054 3E 00               A    98    			ld a, __CS0_BMC_INIT_PARAM
000056 ED39F0              A    99    			out0 (CS0_BMC), a
000059 3E 00               A   100    			ld a, __CS0_CTL_INIT_PARAM
00005B ED39AA              A   101    			out0 (CS0_CTL), a
                           A   102    
00005E 3E 00               A   103    			ld a, __CS1_LBR_INIT_PARAM
000060 ED39AB              A   104    			out0 (CS1_LBR), a
000063 3E 00               A   105    			ld a, __CS1_UBR_INIT_PARAM
000065 ED39AC              A   106    			out0 (CS1_UBR), a
000068 3E 00               A   107    			ld a, __CS1_BMC_INIT_PARAM
00006A ED39F1              A   108    			out0 (CS1_BMC), a
00006D 3E 00               A   109    			ld a, __CS1_CTL_INIT_PARAM
00006F ED39AD              A   110    			out0 (CS1_CTL), a
                           A   111    
000072 3E 00               A   112    			ld a, __CS2_LBR_INIT_PARAM
000074 ED39AE              A   113    			out0 (CS2_LBR), a
000077 3E 00               A   114    			ld a, __CS2_UBR_INIT_PARAM
000079 ED39AF              A   115    			out0 (CS2_UBR), a
00007C 3E 00               A   116    			ld a, __CS2_BMC_INIT_PARAM
00007E ED39F2              A   117    			out0 (CS2_BMC), a
000081 3E 00               A   118    			ld a, __CS2_CTL_INIT_PARAM
000083 ED39B0              A   119    			out0 (CS2_CTL), a
                           A   120    
000086 3E 00               A   121    			ld a, __CS3_LBR_INIT_PARAM
000088 ED39B1              A   122    			out0 (CS3_LBR), a
00008B 3E 00               A   123    			ld a, __CS3_UBR_INIT_PARAM
00008D ED39B2              A   124    			out0 (CS3_UBR), a
000090 3E 00               A   125    			ld a, __CS3_BMC_INIT_PARAM
000092 ED39F3              A   126    			out0 (CS3_BMC), a
000095 3E 00               A   127    			ld a, __CS3_CTL_INIT_PARAM
000097 ED39B3              A   128    			out0 (CS3_CTL), a
                           A   129    ;   
                           A   130    ; Enable internal memory
                           A   131    ;
00009A 3E 00               A   132    			ld a, __FLASH_ADDR_U_INIT_PARAM
00009C ED39F7              A   133    			out0 (FLASH_ADDR_U), a
00009F 3E 00               A   134    			ld a, __FLASH_CTL_INIT_PARAM
0000A1 ED39F8              A   135    			out0 (FLASH_CTRL), a
                           A   136    
0000A4 3E 00               A   137    			ld a, __RAM_ADDR_U_INIT_PARAM
0000A6 ED39B5              A   138    			out0 (RAM_ADDR_U), a
0000A9 3E 00               A   139    			ld a, __RAM_CTL_INIT_PARAM
0000AB ED39B4              A   140    			out0 (RAM_CTL), a
                           A   141    ;
                           A   142    ; Setup Stack Pointer
                           A   143    ;
0000AE 31 00 00 00         A   144    			ld sp, __stack
                           A   145    ;
                           A   146    ; Detect warm or cold boot
                           A   147    ;
0000B2 ED57                A   148    			ld a, i			; Register I should
0000B4 B7                  A   149    			or a, a		
0000B5 3E01                A   150    			ld a, 1			; Set to 1 if cold 
0000B7 28 01               A   151    			jr z, __coldBoot
0000B9 3D                  A   152    			dec a			; Otherwise set to 
0000BA F5                  A   153    __coldBoot:		push af 		; Stack AF, wil
                           A   154    ;
                           A   155    ; Initialize the interrupt vector table
                           A   156    ;
0000BB CD 00 00 00         A   157    			call __init_default_vectors
                           A   158    ;
                           A   159    ; Further hardware/firmware initialisation
                           A   160    ;
0000BF 3E09                A   161    			LD	A, GPIOMODE_INTRE
0000C1 0602                A   162    			LD	B, 2
0000C3 CD 00 00 00         A   163    			CALL	GPIOB_SETMODE
                           A   164    ;
                           A   165    ; Start application
                           A   166    ;
0000C7 3E 00               A   167    			ld a, __cstartup
0000C9 B7                  A   168    			or a, a
0000CA 28 09               A   169    			jr z, __no_cstartup
0000CC CD 00 00 00         A   170    			call __c_startup
                           A   171    
0000D0 F1                  A   172    			pop af			; Pop the coldboot 
0000D1 32 00 00 00         A   173    			ld (_coldBoot), a	; And store
                           A   174    
                           A   175    
0000D5 21000000            A   176    __no_cstartup:		ld hl, 0                ; h
0000D9 E5                  A   177    			push hl                 ; argv[0] =
0000DA DD210000 00         A   178    			ld ix, 0
0000DF DD39                A   179    			add ix, sp              ; ix = &arg
0000E1 DDE5                A   180    			push ix                 ; &argv[0]
0000E3 E1                  A   181    			pop hl
0000E4 11000000            A   182    			ld de, 0                ; argc = 0
0000E8 CD 00 00 00         A   183    			call _main              ; int main(
0000EC D1                  A   184    			pop de			; clean the stack
                           A   185    
0000ED                     A   186    __exit:
0000ED                     A   187    _exit:
0000ED 18 FE               A   188    _abort:			jr $                	; If we
                           A   189    
                           A   190    ; Execute a program in RAM
                           A   191    ; void * _exec16(unsigned long address)
                           A   192    ; Params:
                           A   193    ; - address: The 24-bit address to call
                           A   194    ;
                           A   195    ; This function will call the 24 bit address an
                           A   196    ; The called function must do a RET.LIS (49h, C
                           A   197    ;
0000EF                     A   198    __exec16:
0000EF FDE5                A   199    _exec16:		PUSH 	IY
0000F1 FD210000 00         A   200    			LD	IY, 0
0000F6 FD39                A   201    			ADD	IY, SP		; Standard prologue
0000F8 F5                  A   202    			PUSH 	AF		; Stack any registe
0000F9 D5                  A   203    			PUSH	DE
0000FA E5                  A   204    			PUSH	HL
0000FB ED6E                A   205    			LD	A, MB
0000FD F5                  A   206    			PUSH	AF
0000FE FD1706              A   207    			LD	DE, (IY+6)	; Get the address
000101 FD7E08              A   208    			LD	A, (IY+8)	; And the high byte
000104 ED6D                A   209    			LD	MB, A		; Set the MBASE reg
                           A   210    ;
                           A   211    ; Write out a short subroutine "CALL.IS (DE): R
                           A   212    ;
000106 FD21 02 00 00       A   213    			LD	IY,_callSM	; Storage for the s
00010B FD360049            A   214    			LD	(IY + 0), 49h	; CALL.IS llhh
00010F FD3601CD            A   215    			LD	(IY + 1), CDh
000113 FD7302              A   216    			LD	(IY + 2), E
000116 FD7203              A   217    			LD	(IY + 3), D
000119 FD3604C9            A   218    			LD	(IY + 4), C9h	; RET		
00011D CD 02 00 00         A   219    			CALL	_callSM		; Call the subr
                           A   220    			
000121 F1                  A   221    			POP	AF		; Restore the MBASE reg
000122 ED6D                A   222    			LD	MB, A
000124 E1                  A   223    			POP	HL		; Balance the stack
000125 D1                  A   224    			POP	DE
000126 F1                  A   225    			POP 	AF
000127 FDF9                A   226    			LD	SP, IY          ; Standard epil
000129 FDE1                A   227    			POP	IY
00012B C9                  A   228    			RET		 
                           A   229    
                           A   230    ; Define global constants
                           A   231    ;
                           A   232    			XREF _SYS_CLK_FREQ
                           A   233    			XDEF _SysClkFreq
                           A   234    
00012C 00000000            A   235    _SysClkFreq:		DL _SYS_CLK_FREQ
                           A   236    	
                           A   237    ; Define global vars
                           A   238    ;
                           A   239    			SEGMENT DATA
                           A   240    		
                           A   241    			XDEF _coldBoot		
                           A   242    			XDEF _keycode
                           A   243    
000000                     A   244    _coldBoot:		DS 1			; extern char _
000001                     A   245    _keycode:		DS 1
000002                     A   246    _callSM:		DS 5			; Self-modding 
                           A   247    	
                           A   248    			END


Errors: 0
Warnings: 0
Lines Assembled: 536
