Zilog eZ80 Macro Assembler Version 4.3 (19073001)06-Aug-22     16:31:58     page:   1


PC     Object              I  Line    Source 
                           A     1    ; Zilog eZ80 ANSI C Compiler Release 3.4
                           A     2    ; -nomodsect -optspeed -noreduceopt -nopadbranc
                           A     3    ; -peephole -globalopt -localcse -const=ROM 
                           A     4    	FILE	"..\src\timer.c"
                           A     5    	.assume ADL=1
                           A     6    .DEBUG "C"
                           A     7    	SEGMENT DATA
000000                     A     8    _g_timer:
000000 0000                A     9    	DW	0
000002 00                  A    10    	DB	0
                           A    11    .DEFINE "g_timer"
                           A    12    .ALIAS "_g_timer"
                           A    13    .CLASS 69
                           A    14    .VALUE _g_timer
                           A    15    .TYPE 14
                           A    16    .ENDEF
                           A    17    ;    1	/*
                           A    18    ;    2	 * Title:			AGON MOS - Timer
                           A    19    ;    3	 * Author:			Cocoacrumbs
                           A    20    ;    4	 * Modified by:		Dean Belfield
                           A    21    ;    5	 * Created:			19/06/2022
                           A    22    ;    6	 * Last Updated:	19/06/2022
                           A    23    ;    7	 * 
                           A    24    ;    8	 * Thank you to @CoCoaCrumbs fo this co
                           A    25    ;    9	 *
                           A    26    ;   10	 * Modinfo:
                           A    27    ;   11	 * 11/07/2022:		Removed unused func
                           A    28    ;   12	 */
                           A    29    ;   13	
                           A    30    ;   14	#include <eZ80.h>
                           A    31    ;   15	
                           A    32    ;   16	#define TMR2_IVECT 0x0e
                           A    33    ;   17	
                           A    34    ;   18	static unsigned int volatile g_timer = 
                           A    35    	SEGMENT CODE
                           A    36    ;   19	
                           A    37    ;   20	extern long SysClkFreq;
                           A    38    ;   21	
                           A    39    ;   22	void * set_vector(unsigned int vector, 
                           A    40    ;   23	
                           A    41    ;   24	void interrupt timer2_isr(void) {
000000                     A    42    _timer2_isr:
                           A    43    .DEFINE "_timer2_isr"
                           A    44    
                           A    45    .VALUE _timer2_isr
                           A    46    
                           A    47    .CLASS 2
                           A    48    
                           A    49    .TYPE 65
                           A    50    
                           A    51    .ENDEF
                           A    52    
                           A    53    .BEGFUNC "timer2_isr",24,"_timer2_isr"
                           A    54    
                           A    55    .LINE 24
                           A    56    
                           A    57    .DEFINE "tmp"
                           A    58    
                           A    59    .CLASS 65
                           A    60    
                           A    61    .VALUE -1
                           A    62    
                           A    63    .TYPE 12
                           A    64    
                           A    65    .ENDEF
                           A    66    
000000 FDE5                A    67    	PUSH	IY
000002 D9                  A    68    	EXX	
000003 08                  A    69    	EX	AF,AF'
000004 DDE5                A    70    	PUSH	IX
000006 DD210000 00         A    71    	LD	IX,0
00000B DD39                A    72    	ADD	IX,SP
00000D 3B                  A    73    	DEC	SP
                           A    74    ;   25		unsigned char tmp;
                           A    75    ;   26		tmp = TMR2_CTL;
                           A    76    .LINE 26
                           A    77    
00000E ED3886              A    78    	IN0	A,(134)
000011 DD77FF              A    79    	LD	(IX+%FFFFFFFF),A
                           A    80    ;   27	    g_timer++;
                           A    81    .LINE 27
                           A    82    
000014 ED4B 00 00 00       A    83    	LD	BC,(_g_timer)
000019 ED4B 00 00 00       A    84    	LD	BC,(_g_timer)
00001E 03                  A    85    	INC	BC
00001F ED43 00 00 00       A    86    	LD	(_g_timer),BC
                           A    87    ;   28	} 
                           A    88    .LINE 28
                           A    89    
000024 D9                  A    90    	EXX	
000025 08                  A    91    	EX	AF,AF'
000026 DDF9                A    92    	LD	SP,IX
000028 DDE1                A    93    	POP	IX
00002A FDE1                A    94    	POP	IY
00002C FB                  A    95    	EI	
00002D ED4D                A    96    	RETI	
                           A    97    
                           A    98    
                           A    99    ;**************************** _timer2_isr *****
                           A   100    ;Name                         Addr/Register   S
                           A   101    ;_g_timer                            STATIC    
                           A   102    ;tmp                                   IX-1    
                           A   103    
                           A   104    
                           A   105    ; Stack Frame Size: 7 (bytes)
                           A   106    ;       Spill Code: 0 (instruction)
                           A   107    
                           A   108    
                           A   109    .ENDFUNC "timer2_isr",28,"_timer2_isr"
                           A   110    ;   29	
                           A   111    ;   30	void init_timer2(int interval) {
00002F                     A   112    _init_timer2:
                           A   113    .DEFINE "_init_timer2"
                           A   114    
                           A   115    .VALUE _init_timer2
                           A   116    
                           A   117    .CLASS 2
                           A   118    
                           A   119    .TYPE 65
                           A   120    
                           A   121    .ENDEF
                           A   122    
                           A   123    .BEGFUNC "init_timer2",30,"_init_timer2"
                           A   124    
                           A   125    .LINE 30
                           A   126    
                           A   127    .DEFINE "interval"
                           A   128    
                           A   129    .CLASS 65
                           A   130    
                           A   131    .VALUE 6
                           A   132    
                           A   133    .TYPE 4
                           A   134    
                           A   135    .ENDEF
                           A   136    
                           A   137    .DEFINE "rr"
                           A   138    
                           A   139    .CLASS 65
                           A   140    
                           A   141    .VALUE -2
                           A   142    
                           A   143    .TYPE 13
                           A   144    
                           A   145    .ENDEF
                           A   146    
                           A   147    .DEFINE "tmp"
                           A   148    
                           A   149    .CLASS 65
                           A   150    
                           A   151    .VALUE -3
                           A   152    
                           A   153    .TYPE 12
                           A   154    
                           A   155    .ENDEF
                           A   156    
00002F DDE5                A   157    	PUSH	IX
000031 DD210000 00         A   158    	LD	IX,0
000036 DD39                A   159    	ADD	IX,SP
000038 C5                  A   160    	PUSH	BC
                           A   161    ;   31		unsigned char tmp;
                           A   162    ;   32		unsigned short rr;
                           A   163    ;   33	
                           A   164    ;   34		TMR2_CTL = 0x00;
                           A   165    .LINE 34
                           A   166    
000039 AF                  A   167    	XOR	A,A
00003A ED3986              A   168    	OUT0	(134),A
                           A   169    ;   35	
                           A   170    ;   36		// Set Timer 2 interrupt vector 
                           A   171    ;   37		//
                           A   172    ;   38	    set_vector(TMR2_IVECT, timer2_isr);
                           A   173    .LINE 38
                           A   174    
00003D 01 00 00 00         A   175    	LD	BC,_timer2_isr
000041 C5                  A   176    	PUSH	BC
000042 010E0000            A   177    	LD	BC,14
000046 C5                  A   178    	PUSH	BC
000047 CD 00 00 00         A   179    	CALL	_set_vector
00004B C1                  A   180    	POP	BC
00004C C1                  A   181    	POP	BC
                           A   182    ;   39	
                           A   183    ;   40		rr = (unsigned short)(((SysClkFreq 
                           A   184    .LINE 40
                           A   185    
00004D 2A 00 00 00         A   186    	LD	HL,(_SysClkFreq)
000051 3A 03 00 00         A   187    	LD	A,(_SysClkFreq+3)
000055 5F                  A   188    	LD	E,A
000056 01E80300            A   189    	LD	BC,1000
00005A AF                  A   190    	XOR	A,A
00005B CD 00 00 00         A   191    	CALL	__ldivs
00005F DD0706              A   192    	LD	BC,(IX+%6)
000062 CD 00 00 00         A   193    	CALL	__itol
000066 CD 00 00 00         A   194    	CALL	__lmuls
00006A 01100000            A   195    	LD	BC,16
00006E AF                  A   196    	XOR	A,A
00006F CD 00 00 00         A   197    	CALL	__ldivs
000073 DD75FE              A   198    	LD	(IX+%FFFFFFFE),L
000076 DD74FF              A   199    	LD	(IX+%FFFFFFFF),H
                           A   200    ;   41	
                           A   201    ;   42		TMR2_RR_H = (unsigned char)(rr >> 8
                           A   202    .LINE 42
                           A   203    
000079 DD07FE              A   204    	LD	BC,(IX+%FFFFFFFE)
00007C CD 00 00 00         A   205    	CALL	__stoiu
000080 E5C1                A   206    	LD	BC,HL
000082 3B                  A   207    	DEC	SP
000083 C5                  A   208    	PUSH	BC
000084 33                  A   209    	INC	SP
000085 F1                  A   210    	POP	AF
000086 17ED62              A   211    	SEXT	HL
000089 E5                  A   212    	PUSH	HL
00008A C5                  A   213    	PUSH	BC
00008B 33                  A   214    	INC	SP
00008C E1                  A   215    	POP	HL
00008D 33                  A   216    	INC	SP
00008E 33                  A   217    	INC	SP
00008F 7D                  A   218    	LD	A,L
000090 ED3988              A   219    	OUT0	(136),A
                           A   220    ;   43		TMR2_RR_L = (unsigned char)(rr);
                           A   221    .LINE 43
                           A   222    
000093 DD7EFE              A   223    	LD	A,(IX+%FFFFFFFE)
000096 ED3987              A   224    	OUT0	(135),A
                           A   225    ;   44	
                           A   226    ;   45		tmp = TMR2_CTL;
                           A   227    .LINE 45
                           A   228    
000099 ED3886              A   229    	IN0	A,(134)
00009C DD77FD              A   230    	LD	(IX+%FFFFFFFD),A
                           A   231    ;   46	    TMR2_CTL = 0x57;
                           A   232    .LINE 46
                           A   233    
00009F 3E57                A   234    	LD	A,%57
0000A1 ED3986              A   235    	OUT0	(134),A
                           A   236    ;   47	}
                           A   237    .LINE 47
                           A   238    
0000A4 DDF9                A   239    	LD	SP,IX
0000A6 DDE1                A   240    	POP	IX
0000A8 C9                  A   241    	RET	
                           A   242    
                           A   243    
                           A   244    ;**************************** _init_timer2 ****
                           A   245    ;Name                         Addr/Register   S
                           A   246    ;_SysClkFreq                         IMPORT    
                           A   247    ;_set_vector                         IMPORT  --
                           A   248    ;tmp                                   IX-3    
                           A   249    ;rr                                    IX-2    
                           A   250    ;interval                              IX+6    
                           A   251    
                           A   252    
                           A   253    ; Stack Frame Size: 12 (bytes)
                           A   254    ;       Spill Code: 0 (instruction)
                           A   255    
                           A   256    
                           A   257    .ENDFUNC "init_timer2",47,"_init_timer2"
                           A   258    ;   48	
                           A   259    ;   49	void delayms(int ms) {  
0000A9                     A   260    _delayms:
                           A   261    .DEFINE "_delayms"
                           A   262    
                           A   263    .VALUE _delayms
                           A   264    
                           A   265    .CLASS 2
                           A   266    
                           A   267    .TYPE 65
                           A   268    
                           A   269    .ENDEF
                           A   270    
                           A   271    .BEGFUNC "delayms",49,"_delayms"
                           A   272    
                           A   273    .LINE 49
                           A   274    
                           A   275    .DEFINE "ms"
                           A   276    
                           A   277    .CLASS 65
                           A   278    
                           A   279    .VALUE 6
                           A   280    
                           A   281    .TYPE 4
                           A   282    
                           A   283    .ENDEF
                           A   284    
0000A9 DDE5                A   285    	PUSH	IX
0000AB DD210000 00         A   286    	LD	IX,0
0000B0 DD39                A   287    	ADD	IX,SP
                           A   288    ;   50	    g_timer = 0;
                           A   289    .LINE 50
                           A   290    
0000B2 01000000            A   291    	LD	BC,0
0000B6 ED43 00 00 00       A   292    	LD	(_g_timer),BC
                           A   293    ;   51		while (g_timer < ms); 
0000BB                     A   294    L_4:
                           A   295    .LINE 51
                           A   296    
0000BB DD0706              A   297    	LD	BC,(IX+%6)
0000BE 2A 00 00 00         A   298    	LD	HL,(_g_timer)
0000C2 B7                  A   299    	OR	A,A
0000C3 ED42                A   300    	SBC	HL,BC
0000C5 38 F4               A   301    	JR	C,L_4
                           A   302    ;   52	} 
                           A   303    .LINE 52
                           A   304    
0000C7 DDF9                A   305    	LD	SP,IX
0000C9 DDE1                A   306    	POP	IX
0000CB C9                  A   307    	RET	
                           A   308    
                           A   309    
                           A   310    ;**************************** _delayms ********
                           A   311    ;Name                         Addr/Register   S
                           A   312    ;_g_timer                            STATIC    
                           A   313    ;ms                                    IX+6    
                           A   314    
                           A   315    
                           A   316    ; Stack Frame Size: 9 (bytes)
                           A   317    ;       Spill Code: 0 (instruction)
                           A   318    
                           A   319    
                           A   320    .ENDFUNC "delayms",52,"_delayms"
                           A   321    	XREF _set_vector:ROM
                           A   322    	XREF _SysClkFreq:ROM
                           A   323    	XREF __ldivs:ROM
                           A   324    	XREF __lmuls:ROM
                           A   325    	XREF __stoiu:ROM
                           A   326    	XREF __itol:ROM
                           A   327    	XDEF _delayms
                           A   328    	XDEF _init_timer2
                           A   329    	XDEF _timer2_isr
                           A   330    	END


Errors: 0
Warnings: 0
Lines Assembled: 331
